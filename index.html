<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Preview</title>
</head>
<body>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Khatabook - All in One</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- General Variables & Resets --- */
        :root {
            --primary-color: #4CAF50; /* Green from original Khatabook logo */
            --primary-dark: #388E3C;
            --secondary-color: #FFC107; /* Amber for accents */
            --success-color: #28a745; /* Original green for success */
            --danger-color: #dc3545; /* Original red for danger */
            --text-dark: #333;
            --text-light: #666;
            --bg-light: #f4f7f6;
            --bg-medium: #e9ecef;
            --card-bg: #ffffff;
            --border-color: #ddd;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        /* NEW COLOR MAPPING FOR GIVEN/BORROWED */
        /* You Lent (Given) - should be Red */
        .lent-card .amount-display,
        .you-gave-col {
            color: var(--danger-color) !important; /* Override with red */
        }
        .you-gave-col {
            background-color: #ffe6e6; /* Light red background */
        }

        /* You Borrowed (Taken) - should be Green */
        .borrowed-card .amount-display,
        .you-got-col {
            color: var(--success-color) !important; /* Override with green */
        }
        .you-got-col {
            background-color: #e6ffe6; /* Light green background */
        }
        /* Update transaction header colors */
        .transaction-header > div:nth-child(2) { /* YOU GAVE */
            color: var(--danger-color) !important;
        }
        .transaction-header > div:last-child { /* YOU GOT */
            color: var(--success-color) !important;
        }


        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden; /* Prevent horizontal scroll from animations */
            min-height: 100vh; /* Ensure body takes full height */
            display: flex; /* Use flex for app-container */
            flex-direction: column; /* Allow content to stack */
        }

        /* --- Global Container & Page Transitions --- */
        .app-container {
            flex-grow: 1; /* Allow container to fill available height */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top instead of center for dashboard */
            padding: 20px;
            overflow: auto; /* Allow scrolling within the container */
        }

        .page-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-medium);
            padding: 40px;
            width: 100%;
            max-width: 500px; /* Default max-width for auth sections */
            text-align: center;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            display: none; /* Hidden by default, shown by JS */
            opacity: 0;
            margin: 20px auto; /* Add margin for spacing */
        }

        .page-section.active {
            display: block;
            opacity: 1;
            animation: fadeInScale 0.6s ease-out forwards;
        }

        .page-section:not(.active) {
            animation: fadeOutScale 0.4s ease-in forwards;
            pointer-events: none; /* Prevent interaction while fading out */
        }

        /* Fixed Responsive Centering for Auth Sections */
#login-section.active,
#signup-section.active,
#forgot-password-section.active {
    position: relative;
    margin: auto;
    top: unset;
    left: unset;
    transform: none;
    max-height: none;
    overflow: visible;
    padding: 30px 20px;
    display: block;
}
        #login-section, #signup-section, #forgot-password-section {
             background-color: var(--card-bg);
             max-width: 450px;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes fadeOutScale {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        /* --- Headings --- */
        h1 {
            font-size: 2.5em;
            color: var(--primary-dark);
            margin-bottom: 20px;
            font-weight: 700;
        }

        h2 {
            font-size: 2em;
            color: var(--primary-color);
            margin-bottom: 30px;
            font-weight: 600;
        }

        h3 {
            font-size: 1.5em;
            color: var(--text-dark);
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* --- Form Styles --- */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }

        input[type="email"],
        input[type="password"],
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background-color: var(--bg-light);
            transition: all 0.3s ease;
        }

        input[type="email"]:focus,
        input[type="password"]:focus,
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
            outline: none;
            background-color: white;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            /* Added for text overflow in textarea */
            word-wrap: break-word; /* For breaking long words */
            overflow-wrap: break-word;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: var(--text-light);
            font-size: 0.85em;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
            /* Added for flex items containing long content */
            min-width: 0; /* Allows content to shrink */
        }

        /* --- Buttons --- */
        .btn {
            display: inline-block;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 600;
            margin-top: 10px; /* Default margin for buttons */
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--secondary-color);
            color: var(--text-dark);
        }

        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }
        .btn-info { /* New button style for View Details */
            background-color: #17a2b8;
            color: white;
        }
        .btn-info:hover {
            background-color: #138496;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn + .btn {
            margin-left: 10px;
        }

        /* --- Links --- */
        p {
            margin-top: 20px;
            font-size: 0.95em;
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        a:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }

        /* --- Message Display --- */
        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.95em;
            display: none;
            animation: fadeIn 0.5s forwards;
            font-weight: 500;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Dashboard Header --- */
        .dashboard-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-light);
            border-radius: 10px;
            margin-bottom: 25px;
            animation: slideInFromTop 0.8s ease-out forwards;
        }

        @keyframes slideInFromTop {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-header h1 {
            font-size: 1.8em;
            margin: 0;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            font-weight: 500;
            font-size: 1.1em;
        }

        /* --- Dashboard Main Content --- */
        .dashboard-main {
            max-width: 1000px; /* Wider dashboard for more content */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
            animation: fadeIn 1s ease-out forwards;
            padding-bottom: 20px; /* Add some padding at the bottom */
        }

        /* Specific styles for dashboard section, override default .page-section */
        #dashboard-section {
            max-width: 1000px; /* Wider than auth sections */
            padding: 20px; /* Adjust padding if needed */
            text-align: left; /* Align dashboard content left */
            position: static; /* Remove absolute positioning */
            transform: none; /* Remove transform */
            margin: 0 auto; /* Center it horizontally */
            width: calc(100% - 40px); /* Account for app-container padding */
        }


        /* --- Summary Cards --- */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: var(--shadow-light);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }

        .card h3 {
            margin-bottom: 12px;
            font-size: 1.2em;
            color: var(--text-light);
        }

        .card .amount-display {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--text-dark); /* Default, overridden by specific card types */
            /* Added for amount overflow */
            word-break: break-all;
            overflow-wrap: break-word;
        }

        /* --- Sections for Add Entry & People Summary --- */
        .add-entry-section,
        .people-summary-section,
        .entry-list-section { /* Added entry-list-section for modal */
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
        }

        .add-entry-section h3,
        .people-summary-section h3,
        .entry-list-section h3 { /* Added for modal entry list */
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-dark);
        }
        /* Styles for the "Add New Entry" section inside the Person Details Modal */
        .add-entry-section.compact {
            padding: 10px; /* Smaller padding */
            box-shadow: none;
            border: 1px solid var(--border-color);
            margin-bottom: 10px; /* Smaller margin below the section */
        }
        .add-entry-section.compact h3 {
            font-size: 1.1em; /* Even smaller font for h3 title */
            margin-bottom: 10px; /* Reduced margin below h3 */
        }
        .add-entry-section.compact .form-group {
            margin-bottom: 8px; /* Smaller margin between form groups */
        }
        .add-entry-section.compact label {
            font-size: 0.85em; /* Smaller label font */
            margin-bottom: 3px; /* Reduced label margin */
        }
        .add-entry-section.compact input[type="number"],
        .add-entry-section.compact select,
        .add-entry-section.compact textarea {
            padding: 6px 8px; /* Smaller input padding */
            font-size: 0.85em; /* Smaller input font */
            border-radius: 5px; /* Slightly smaller border radius */
        }
        .add-entry-section.compact .form-row {
            gap: 8px; /* Smaller gap in form row */
            margin-bottom: 8px; /* Smaller margin for form row */
        }
        .add-entry-section.compact .btn {
            padding: 6px 12px; /* Smaller button padding */
            font-size: 0.85em; /* Smaller button font */
            margin-top: 8px; /* Reduced button margin */
        }


        .add-entry-section form .btn {
            width: 100%;
        }

        /* --- People Summary List Styles --- */
        .people-list { /* New list for people */
            list-style: none;
            padding: 0;
        }

        .person-item {
            background-color: var(--bg-medium);
            border: 1px solid var(--border-color);
            padding: 15px 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .person-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .person-details {
            flex-grow: 1;
            text-align: left;
            /* Added for handling long names/balances */
            min-width: 0; /* Allows flex item to shrink */
        }

        .person-details strong {
            font-size: 1.2em;
            color: var(--text-dark);
            /* Added for long person names */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .person-details .net-balance {
            font-weight: 700;
            font-size: 1.3em;
            margin-left: 8px;
            /* Added for balance numbers */
            word-break: break-all;
            overflow-wrap: break-word;
        }
        /* Dashboard People Summary Colors Exchanged */
        .person-details .net-balance.lent {
            color: var(--danger-color); /* Previously green, now red */
        }
        .person-details .net-balance.borrowed {
            color: var(--success-color); /* Previously red, now green */
        }

        .person-details small {
            display: block;
            color: var(--text-light);
            margin-top: 5px;
            font-size: 0.85em;
            /* Added for long notes/last activity text */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .person-actions {
            display: flex;
            gap: 8px;
        }

        .person-actions .btn {
            padding: 8px 15px;
            font-size: 0.85em;
            margin-top: 0;
        }

        .no-entries { /* Reused for no people */
            text-align: center;
            color: var(--text-light);
            font-style: italic;
            padding: 20px;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            margin-top: 20px;
        }

        /* --- Transaction List within Modal - NEW STYLES --- */
        .transaction-history-container {
            margin-top: 20px; /* Adjusted margin top */
        }

        .transaction-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr; /* ENTRIES, YOU GAVE, YOU GOT */
            padding: 10px 0;
            font-weight: 600;
            color: var(--text-light);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background-color: var(--card-bg); /* Ensure header is visible when scrolling */
            z-index: 2; /* Above transaction rows */
            font-size: 0.9em;
        }
        .transaction-header > div:last-child,
        .transaction-header > div:nth-child(2) {
            text-align: right;
        }
        .transaction-header > div:first-child {
            padding-left: 10px;
        }


        .transaction-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }

        .date-separator {
            background-color: var(--bg-medium);
            color: var(--text-light);
            font-size: 0.8em; /* Slightly smaller font */
            font-weight: 600;
            padding: 6px 10px; /* Reduced padding */
            margin: 10px 0 5px 0; /* Reduced margins */
            border-radius: 5px;
            text-align: center;
            position: sticky;
            top: 40px; /* Below the main header */
            z-index: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        @media (max-width: 768px) {
            .date-separator {
                top: 35px; /* Adjust for smaller header */
            }
        }


        .transaction-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            font-size: 0.95em;
            cursor: pointer; /* Make it look clickable */
            transition: background-color 0.2s ease;
        }
        .transaction-row:hover {
            background-color: var(--bg-medium); /* Hover effect */
        }


        .transaction-row:last-child {
            border-bottom: none;
        }

        .entries-col {
            padding-left: 10px;
            /* Added for content within entries-col */
            min-width: 0; /* Allows flex/grid item to shrink */
        }

        .balance-info {
            font-size: 0.8em;
            color: var(--text-light);
            margin-bottom: 3px;
        }

        .running-balance {
            font-weight: 600;
            /* Added for balance digits overflow */
            word-break: break-all;
            overflow-wrap: break-word;
        }
        /* BAL money colors exchanged logic */
        .running-balance.lent { /* If I have given extra (positive balance) -> Red */
            color: var(--danger-color);
        }
        .running-balance.borrowed { /* If I have borrowed extra (negative balance) -> Green */
            color: var(--success-color);
        }
        .running-balance.settled { /* If BAL is 0 -> Yellow */
            color: var(--secondary-color);
        }


        .transaction-description {
            font-weight: 500;
            color: var(--text-dark);
            /* Added for description overflow */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .transaction-notes {
             font-size: 0.8em;
             color: var(--text-light);
             margin-top: 2px;
             display: block;
             /* Added for notes overflow */
             word-wrap: break-word;
             overflow-wrap: break-word;
        }
        .transaction-datetime {
            font-size: 0.7em; /* Tiny font */
            color: #888; /* Slightly darker than text-light */
            margin-top: 2px;
            display: block;
        }


        .you-gave-col,
        .you-got-col {
            text-align: right;
            font-weight: 600;
            font-size: 1em;
            padding-right: 10px;
            padding: 8px 10px; /* Consistent padding */
            margin-left: 5px; /* Visual separation */
            border-radius: 5px;
            /* Added for amount digits overflow */
            word-break: break-all;
            overflow-wrap: break-word;
        }


        /* --- Modal Styles --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            background-color: rgba(0,0,0,0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

#editModal {
    z-index: 1100 !important; /* Higher than personDetailsModal */
}

#editModal .modal-content {
    position: relative;
    z-index: 1101;
}

        .modal.active {
            display: flex;
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-medium);
            width: 90%;
            max-width: 550px;
            position: relative;
            transform: translateY(-20px); /* Initial position for animation */
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-height: 90vh; /* Limit modal height */
            overflow-y: auto; /* Make the entire modal content scrollable */
            display: flex; /* Flex for inner content */
            flex-direction: column; /* Stack content */
        }
        .modal-content-scrollable {
            /* flex-grow: 1; Removed as per user request */
            /* overflow-y: auto; Removed as per user request */
            /* This div now acts as a container for transaction history, not a scrollable area itself */
        }


        .modal.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .close-button {
            color: var(--text-light);
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
            z-index: 1200; /* Ensure it's above everything */
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--danger-color);
        }

        .modal h2 {
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        .modal form .btn-group { /* Group buttons in modal forms */
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 25px;
        }
        .modal form .btn-group .btn {
            flex: 1;
            margin-top: 0; /* Reset margin for buttons within group */
        }
        .modal form .btn:not(.btn-group .btn) { /* For single buttons */
            margin-top: 25px;
        }


        /* Removed .sticky-buttons-container styles */


        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            .app-container {
                padding: 10px; /* Reduced padding for very small screens */
            }

            .page-section {
                padding: 25px 20px; /* Adjusted padding */
                max-width: 100%; /* Use full width */
                margin: 10px auto; /* Smaller margin */
            }

            #dashboard-section {
                padding: 15px; /* Adjust padding for dashboard section */
                width: 100%;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                padding: 15px 20px;
                border-radius: 8px; /* Slightly smaller border radius */
            }
            .dashboard-header h1 {
                font-size: 1.5em;
            }
            .user-info {
                flex-direction: column;
                gap: 5px;
                font-size: 0.9em;
            }

            /* Mobile dashboard cards: horizontal and smaller titles */
            .summary-cards {
                display: flex; /* Use flexbox for horizontal layout */
                flex-direction: row; /* Arrange horizontally */
                gap: 15px; /* Space between cards */
                flex-wrap: wrap; /* Allow wrapping if space is too tight */
                justify-content: center; /* Center cards */
            }

            .summary-cards .card {
                flex: 1; /* Allow cards to grow and shrink */
                min-width: 150px; /* Ensure a minimum width */
                padding: 15px; /* Slightly less padding for mobile cards */
            }
            .summary-cards .card h3 {
                font-size: 0.95em; /* Smaller title font for mobile */
                margin-bottom: 8px; /* Reduced margin */
            }
            .card .amount-display {
                font-size: 1.8em; /* Smaller amount font size */
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }
            .form-row .form-group {
                margin-bottom: 15px;
            }

            .person-item { /* Adjusted for person-item */
                flex-direction: column;
                align-items: flex-start;
                padding: 12px; /* Smaller padding */
            }
            .person-details { /* Adjusted for details */
                margin-bottom: 8px; /* Smaller margin */
                width: 100%;
            }
            .person-details strong {
                font-size: 1em;
            }
            .person-details .net-balance {
                font-size: 1.1em;
            }
            .person-actions {
                width: 100%;
                justify-content: flex-end;
            }
            .person-actions .btn {
                padding: 6px 10px;
                font-size: 0.75em;
            }
            .modal-content {
                padding: 20px; /* Smaller modal padding */
            }
            .close-button {
                font-size: 24px;
                top: 10px;
                right: 15px;
            }
            .modal h2 {
                font-size: 1.5em;
            }

            .transaction-header, .transaction-row {
                grid-template-columns: 1.5fr 1fr 1fr; /* Adjust columns for smaller screens */
                font-size: 0.85em;
            }
            .you-gave-col, .you-got-col {
                padding: 6px 8px;
            }
            /* Removed sticky-buttons-container responsive styles */
        }
    </style>
</head>
<body>

    <div class="app-container">

        <div id="login-section" class="page-section">
            <h2>Login to My Khatabook</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
            <p>Don't have an account? <a href="#" onclick="showSection('signup-section'); return false;">Sign Up</a></p>
            <p><a href="#" onclick="showSection('forgot-password-section'); return false;">Forgot Password?</a></p>
            <div id="loginMessage" class="message"></div>
        </div>

        <div id="signup-section" class="page-section">
            <h2>Create Your Khatabook Account</h2>
            <form id="signupForm">
                <div class="form-group">
                    <label for="signupEmail">Email:</label>
                    <input type="email" id="signupEmail" placeholder="Enter your email" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password:</label>
                    <input type="password" id="signupPassword" placeholder="Choose a password" required autocomplete="new-password">
                    <small>Minimum 6 characters</small>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password:</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm your password" required autocomplete="new-password">
                </div>
                <button type="submit" class="btn btn-primary">Sign Up</button>
            </form>
            <p>Already have an account? <a href="#" onclick="showSection('login-section'); return false;">Login</a></p>
            <div id="signupMessage" class="message"></div>
        </div>

        <div id="forgot-password-section" class="page-section">
            <h2>Forgot Password</h2>
            <p>Enter your email address to receive a password reset link.</p>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label for="resetEmail">Email:</label>
                    <input type="email" id="resetEmail" placeholder="Enter your email" required autocomplete="username">
                </div>
                <button type="submit" class="btn btn-primary">Reset Password</button>
            </form>
            <p><a href="#" onclick="showSection('login-section'); return false;">Back to Login</a></p>
            <div id="forgotPasswordMessage" class="message"></div>
        </div>

        <div id="dashboard-section" class="page-section">
            <div class="dashboard-header">
                <h1>My Khatabook</h1>
                <div class="user-info">
                    <span id="userEmailDisplay"></span>
                    <button id="logoutButton" class="btn btn-danger">Logout</button>
                </div>
            </div>

            <div class="dashboard-main">
                <div class="summary-cards">
                    <div class="card lent-card">
                        <h3>You Lent (Given)</h3>
                        <p class="amount-display" id="totalLent">₹ 0.00</p>
                    </div>
                    <div class="card borrowed-card">
                        <h3>You Borrowed (Taken)</h3>
                        <p class="amount-display" id="totalBorrowed">₹ 0.00</p>
                    </div>
                </div>

                <div class="add-entry-section">
                    <h3>Add New Entry</h3>
                    <form id="addEntryForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="personName">Person Name:</label>
                                <input type="text" id="personName" placeholder="e.g., John Doe" required>
                            </div>
                            <div class="form-group">
                                <label for="amount">Amount (₹):</label>
                                <input type="number" id="amount" placeholder="e.g., 500" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="transactionType">Type:</label>
                                <select id="transactionType" required>
                                    <option value="lent">You Lent (Given)</option>
                                    <option value="borrowed">You Borrowed (Taken)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="notes">Notes (Optional):</label>
                                <textarea id="notes" placeholder="Any specific details"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Entry</button>
                    </form>
                    <div id="entryMessage" class="message"></div>
                </div>

                <div class="people-summary-section">
                    <h3>People Summary</h3>
                    <div id="peopleSummaryList">
                        </div>
                </div>
            </div>
        </div>

        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeEditModalButton">&times;</span>
                <h2>Edit Entry</h2>
                <form id="editEntryForm">
                    <input type="hidden" id="editEntryId">
                    <div class="form-group">
                        <label for="editPersonName">Person Name:</label>
                        <input type="text" id="editPersonName" required>
                    </div>
                    <div class="form-group">
                        <label for="editAmount">Amount (₹):</label>
                        <input type="number" id="editAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="editTransactionType">Type:</label>
                        <select id="editTransactionType" required>
                            <option value="lent">You Lent (Given)</option>
                            <option value="borrowed">You Borrowed (Taken)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editNotes">Notes (Optional):</label>
                        <textarea id="editNotes"></textarea>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Update Entry</button>
                        <button type="button" class="btn btn-danger" id="deleteEntryButton">Delete Entry</button>
                    </div>
                </form>
                <div id="editMessage" class="message"></div>
            </div>
        </div>

        <div id="personDetailsModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closePersonDetailsModalButton">&times;</span>
                <h2 id="personDetailsName"></h2>

                <div class="add-entry-section compact">
                    <h3>Add New Entry for <span id="addEntryForPersonName"></span></h3>
                    <form id="addEntryForPersonForm">
                        <input type="hidden" id="personDetailsModalPersonName">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="amountForPerson">Amount (₹):</label>
                                <input type="number" id="amountForPerson" placeholder="e.g., 500" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="transactionTypeForPerson">Type:</label>
                                <select id="transactionTypeForPerson" required>
                                    <option value="lent">You Lent (Given)</option>
                                    <option value="borrowed">You Borrowed (Taken)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="notesForPerson">Notes (Optional):</label>
                                <textarea id="notesForPerson" placeholder="Any specific details"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Entry</button>
                    </form>
                    <div id="entryForPersonMessage" class="message"></div>
                </div>

                <div class="transaction-history-container modal-content-scrollable">
                    <div class="transaction-header">
                        <div>ENTRIES</div>
                        <div>YOU GAVE</div>
                        <div>YOU GOT</div>
                    </div>
                    <div id="personTransactionsList" class="transaction-list">
                        </div>
                </div>
                </div>
        </div>

    </div>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

    <script>
        // Your Firebase Configuration (GET THIS FROM FIREBASE CONSOLE)
        // Go to Firebase Console -> Project settings -> Your apps -> Web app
        const firebaseConfig = {
            apiKey: "AIzaSyCFnD9Xt20WKGOtY_S5s3CchvCtRInL2bQ",
            authDomain: "our-khata.firebaseapp.com",
            projectId: "our-khata",
            storageBucket: "our-khata.firebasestorage.app",
            messagingSenderId: "762914243450",
            appId: "1:762914243450:web:a5dc0b9eaf98dbfa86ccc3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- UI Helper Functions ---
        function showMessage(elementId, message, type) {
            const messageElement = document.getElementById(elementId);
            if (messageElement) {
                messageElement.textContent = message;
                messageElement.className = `message ${type}`;
                messageElement.style.display = 'block';
                setTimeout(() => {
                    hideMessage(elementId);
                }, 5000);
            }
        }

        function hideMessage(elementId) {
            const messageElement = document.getElementById(elementId);
            if (messageElement) {
                messageElement.style.display = 'none';
            }
        }

        function showSection(sectionId) {
            const sections = document.querySelectorAll('.page-section');
            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
        }

        // --- Auth State Listener (handles page switching) ---
        let initialLoad = true;
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is logged in
                showSection('dashboard-section');
                const userEmailDisplay = document.getElementById('userEmailDisplay');
                if (userEmailDisplay) {
                    userEmailDisplay.textContent = user.email;
                }
                if (initialLoad) {
                    loadDashboardData(user.uid); // Load initial data on first login
                    initialLoad = false;
                }
            } else {
                // User is NOT logged in
                showSection('login-section'); // Default to login page
                initialLoad = true; // Reset for next login
            }
        });

        // --- Authentication Logic ---

        // Login Form
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginForm['loginEmail'].value;
                const password = loginForm['loginPassword'].value;
                hideMessage('loginMessage');

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    showMessage('loginMessage', 'Login successful! Redirecting...', 'success');
                    // showSection('dashboard-section') is handled by auth.onAuthStateChanged
                } catch (error) {
                    console.error('Login error:', error.message);
                    showMessage('loginMessage', `Login failed: ${error.message}`, 'error');
                }
            });
        }

        // Signup Form
        const signupForm = document.getElementById('signupForm');
        if (signupForm) {
            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = signupForm['signupEmail'].value;
                const password = signupForm['signupPassword'].value;
                const confirmPassword = signupForm['confirmPassword'].value;
                hideMessage('signupMessage');

                if (password.length < 6) {
                    showMessage('signupMessage', 'Password must be at least 6 characters long.', 'error');
                    return;
                }
                if (password !== confirmPassword) {
                    showMessage('signupMessage', 'Passwords do not match.', 'error');
                    return;
                }

                try {
                    await auth.createUserWithEmailAndPassword(email, password);
                    showMessage('signupMessage', 'Account created successfully! Redirecting to login...', 'success');
                    setTimeout(() => {
                        showSection('login-section');
                    }, 2000);
                }
                 catch (error) {
                    console.error('Signup error:', error.message);
                    showMessage('signupMessage', `Signup failed: ${error.message}`, 'error');
                }
            });
        }

        // Forgot Password Form
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        if (forgotPasswordForm) {
            forgotPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = forgotPasswordForm['resetEmail'].value;
                hideMessage('forgotPasswordMessage');

                try {
                    await auth.sendPasswordResetEmail(email);
                    showMessage('forgotPasswordMessage', 'Password reset email sent! Check your inbox.', 'success');
                } catch (error) {
                    console.error('Forgot password error:', error.message);
                    showMessage('forgotPasswordMessage', `Failed to send reset email: ${error.message}`, 'error');
                }
            });
        }

        // Logout Button
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                    console.log('User logged out.');
                    // auth.onAuthStateChanged will handle showing login section
                } catch (error) {
                    console.error('Logout error:', error.message);
                    alert('Failed to log out. Please try again.');
                }
            });
        }

        // --- Dashboard Logic ---

        // Add Khatabook Entry Form (General for new or existing people)
        const addEntryForm = document.getElementById('addEntryForm');
        if (addEntryForm) {
            addEntryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const personName = addEntryForm['personName'].value.trim();
                const amount = parseFloat(addEntryForm['amount'].value);
                const transactionType = addEntryForm['transactionType'].value;
                const notes = addEntryForm['notes'].value.trim();
                hideMessage('entryMessage');

                if (!personName) {
                    showMessage('entryMessage', 'Person Name cannot be empty.', 'error');
                    return;
                }
                if (isNaN(amount) || amount <= 0) {
                    showMessage('entryMessage', 'Please enter a valid positive amount.', 'error');
                    return;
                }

                const user = auth.currentUser;
                if (user) {
                    try {
                        await db.collection('users').doc(user.uid).collection('khatabook').add({
                            personName: personName,
                            amount: amount,
                            transactionType: transactionType,
                            notes: notes,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showMessage('entryMessage', 'Entry added successfully!', 'success');
                        addEntryForm.reset();
                        // Real-time listener loadDashboardData will update
                    } catch (error) {
                        console.error('Error adding entry:', error.message);
                        showMessage('entryMessage', `Failed to add entry: ${error.message}`, 'error');
                    }
                } else {
                    showMessage('entryMessage', 'You must be logged in to add entries.', 'error');
                }
            });
        }

        // Real-time Load Dashboard Data (Summary Cards + People Summary)
        let unsubscribeFromKhatabook = null;

        function loadDashboardData(uid) {
            const peopleSummaryListDiv = document.getElementById('peopleSummaryList');
            const totalLentDisplay = document.getElementById('totalLent');
            const totalBorrowedDisplay = document.getElementById('totalBorrowed');

            if (!peopleSummaryListDiv || !totalLentDisplay || !totalBorrowedDisplay) return;

            // Unsubscribe from previous listener if it exists
            if (unsubscribeFromKhatabook) {
                unsubscribeFromKhatabook();
            }

            unsubscribeFromKhatabook = db.collection('users').doc(uid).collection('khatabook')
                .orderBy('timestamp', 'desc') // We need all entries to calculate totals and last activity per person
                .onSnapshot(snapshot => {
                    const peopleData = {}; // To aggregate data per person

                    if (snapshot.empty) {
                        peopleSummaryListDiv.innerHTML = '<p class="no-entries">No entries yet. Add your first transaction!</p>';
                        totalLentDisplay.textContent = '₹ 0.00';
                        totalBorrowedDisplay.textContent = '₹ 0.00';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const entry = doc.data();
                        const personName = entry.personName;
                        const amount = entry.amount;
                        const transactionType = entry.transactionType;
                        // Firestore Timestamp objects need .toDate() to be converted to JS Date objects
                        const timestamp = entry.timestamp ? entry.timestamp.toDate() : new Date(0); // Use a default old date if timestamp is missing

                        // Aggregate data for people summary
                        if (!peopleData[personName]) {
                            peopleData[personName] = {
                                lent: 0,
                                borrowed: 0,
                                lastActivity: timestamp // Initialize with first transaction's timestamp
                            };
                        }

                        if (transactionType === 'lent') {
                            peopleData[personName].lent += amount;
                        } else if (transactionType === 'borrowed') {
                            peopleData[personName].borrowed += amount;
                        }

                        // Update last activity for this person
                        if (timestamp > peopleData[personName].lastActivity) {
                            peopleData[personName].lastActivity = timestamp;
                        }
                    });

                    // Calculate current lent/borrowed based on net balances from people summary
                    let currentTotalLent = 0;
                    let currentTotalBorrowed = 0;

                    Object.values(peopleData).forEach(data => {
                        const netBalance = data.lent - data.borrowed;
                        if (netBalance > 0) { // If I lent money to this person (positive balance for me)
                            currentTotalLent += netBalance;
                        } else if (netBalance < 0) { // If I borrowed money from this person (negative balance for me)
                            currentTotalBorrowed += Math.abs(netBalance);
                        }
                    });


                    // Update overall summary cards
                    totalLentDisplay.textContent = `₹ ${currentTotalLent.toFixed(2)}`;
                    totalBorrowedDisplay.textContent = `₹ ${currentTotalBorrowed.toFixed(2)}`;

                    // Render People Summary
                    peopleSummaryListDiv.innerHTML = ''; // Clear previous list
                    const ul = document.createElement('ul');
                    ul.classList.add('people-list');

                    const sortedPeople = Object.keys(peopleData).sort((a, b) => {
                        // Sort by last activity descending
                        return peopleData[b].lastActivity.getTime() - peopleData[a].lastActivity.getTime();
                    });

                    sortedPeople.forEach(personName => {
                        const data = peopleData[personName];
                        const netBalance = data.lent - data.borrowed;
                        let balanceText = `₹ ${Math.abs(netBalance).toFixed(2)}`;
                        let balanceClass = '';

                        if (netBalance > 0) {
                            balanceText += ' You Lent';
                            balanceClass = 'lent'; // This will now apply the red color
                        } else if (netBalance < 0) {
                            balanceText += ' You Borrowed';
                            balanceClass = 'borrowed'; // This will now apply the green color
                        } else {
                            balanceText = '₹ 0.00 Settled';
                        }

                        const listItem = document.createElement('li');
                        listItem.classList.add('person-item');
                        listItem.innerHTML = `
                            <div class="person-details">
                                <strong>${personName}</strong>: <span class="net-balance ${balanceClass}">${balanceText}</span>
                                <small>Last activity: ${data.lastActivity.toLocaleString()}</small>
                            </div>
                            <div class="person-actions">
                                <button class="btn btn-info" onclick="openPersonDetailsModal(decodeURIComponent('${encodeURIComponent(personName)}'))">View Details</button>
                                <button class="btn btn-danger" onclick="deletePerson(decodeURIComponent('${encodeURIComponent(personName)}'))">Delete</button>
                            </div>
                        `;
                        ul.appendChild(listItem);
                    });
                    peopleSummaryListDiv.appendChild(ul);

                }, error => {
                    console.error('Error loading dashboard data in real-time:', error.message);
                    showMessage('entryMessage', `Failed to load dashboard: ${error.message}`, 'error');
                });
        }


        // --- Edit Modal Logic (Existing) ---
        const editModal = document.getElementById('editModal');
        const closeEditModalButton = document.getElementById('closeEditModalButton');
        const editEntryForm = document.getElementById('editEntryForm');
        const editEntryIdInput = document.getElementById('editEntryId');
        const editPersonNameInput = document.getElementById('editPersonName');
        const editAmountInput = document.getElementById('editAmount');
        const editTransactionTypeInput = document.getElementById('editTransactionType');
        const editNotesInput = document.getElementById('editNotes');
        const deleteEntryButton = document.getElementById('deleteEntryButton'); // Get the new delete button

        function openEditModal(id, name, amount, type, notes) {
            // Optional: Close personDetailsModal if editModal is opened from there
            document.getElementById('personDetailsModal')?.classList.remove('active'); 
            editEntryIdInput.value = id;
            editPersonNameInput.value = decodeURIComponent(name); // Decode here
            editAmountInput.value = amount;
            editTransactionTypeInput.value = type;
            editNotesInput.value = decodeURIComponent(notes); // Decode here
            hideMessage('editMessage');
            editModal.classList.add('active'); // Use class for modal visibility

            // Set up delete button action
            if (deleteEntryButton) {
                deleteEntryButton.onclick = () => deleteEntry(id);
            }
        }

        if (closeEditModalButton) {
            closeEditModalButton.onclick = function() {
                editModal.classList.remove('active');
            }
        }

        // Close edit modal if clicked outside content
        window.addEventListener('click', function(event) {
            if (event.target == editModal) {
                editModal.classList.remove('active');
            }
        });

        // Handle update form submission
        if (editEntryForm) {
            editEntryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const entryId = editEntryIdInput.value;
                const newPersonName = editPersonNameInput.value.trim();
                const newAmount = parseFloat(editAmountInput.value);
                const newTransactionType = editTransactionTypeInput.value;
                const newNotes = editNotesInput.value.trim();
                hideMessage('editMessage');

                if (!newPersonName) {
                    showMessage('editMessage', 'Person Name cannot be empty.', 'error');
                    return;
                }
                if (isNaN(newAmount) || newAmount <= 0) {
                    showMessage('editMessage', 'Please enter a valid positive amount.', 'error');
                    return;
                }

                const user = auth.currentUser;
                if (user) {
                    try {
                        await db.collection('users').doc(user.uid).collection('khatabook').doc(entryId).update({
                            personName: newPersonName,
                            amount: newAmount,
                            transactionType: newTransactionType,
                            notes: newNotes,
                            // timestamp: firebase.firestore.FieldValue.serverTimestamp() // Removed to prevent position change
                        });
                        showMessage('editMessage', 'Entry updated successfully!', 'success');
                        editModal.classList.remove('active'); // Close modal
                        // Due to onSnapshot listeners, dashboard and person details will auto-update
                    } catch (error) {
                        console.error('Error updating entry:', error.message);
                        showMessage('editMessage', `Failed to update entry: ${error.message}`, 'error');
                    }
                }
            });
        }

        // Delete Entry
        async function deleteEntry(id) {
            if (confirm("Are you sure you want to delete this entry? This action cannot be undone.")) {
                const user = auth.currentUser;
                if (user) {
                    try {
    await db.collection('users').doc(user.uid).collection('khatabook').doc(id).delete();
    showMessage('editMessage', 'Entry deleted successfully!', 'success'); // Show message in edit modal's area
    editModal.classList.remove('active'); // Close modal after deletion

    // ⏳ Wait for Firestore to update, then check person still exists
    setTimeout(() => {
        const currentPerson = personDetailsModalPersonNameInput.value;
        const stillExists = Array.from(document.querySelectorAll('.person-item')).some(item =>
            item.textContent.includes(currentPerson)
        );

        if (!stillExists) {
            // Person no longer exists, close the modal
            personDetailsModal.classList.remove('active');
            if (unsubscribeFromPersonTransactions) {
                unsubscribeFromPersonTransactions();
                unsubscribeFromPersonTransactions = null;
            }
        } else {
            // No explicit refresh needed due to onSnapshot listener
        }
    }, 300);
} catch (error) {
                        console.error('Error deleting entry:', error.message);
                        showMessage('editMessage', `Failed to delete entry: ${error.message}`, 'error');
                    }
                } else {
                    showMessage('editMessage', 'You must be logged in to delete entries.', 'error');
                }
            }
        }

        // --- NEW: Delete Person (all entries for a given person) ---
        async function deletePerson(personName) {
            if (confirm(`Are you sure you want to delete ALL entries for ${personName}? This action cannot be undone.`)) {
                const user = auth.currentUser;
                if (user) {
                    try {
                        // Get all documents for this person
                        const snapshot = await db.collection('users').doc(user.uid).collection('khatabook')
                            .where('personName', '==', personName)
                            .get();

                        if (snapshot.empty) {
                            showMessage('entryMessage', `No entries found for ${personName} to delete.`, 'error');
                            return;
                        }

                        // Create a batch to delete all documents efficiently
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });

                        await batch.commit();
                        showMessage('entryMessage', `All entries for ${personName} deleted successfully!`, 'success');
                        // No explicit refresh needed due to onSnapshot listener on dashboard
                        // If personDetailsModal is open for this person, it will auto-close via its listener
                        personDetailsModal.classList.remove('active'); // Ensure modal closes if open
                    } catch (error) {
                        console.error('Error deleting person and their entries:', error.message);
                        showMessage('entryMessage', `Failed to delete ${personName} and their entries: ${error.message}`, 'error');
                    }
                } else {
                    showMessage('entryMessage', 'You must be logged in to delete entries.', 'error');
                }
            }
        }


        // --- Person Details Modal Logic ---
        const personDetailsModal = document.getElementById('personDetailsModal');
        const closePersonDetailsModalButton = document.getElementById('closePersonDetailsModalButton');
        const personDetailsNameHeader = document.getElementById('personDetailsName');
        const personDetailsModalPersonNameInput = document.getElementById('personDetailsModalPersonName');
        const addEntryForPersonNameSpan = document.getElementById('addEntryForPersonName');
        const addEntryForPersonForm = document.getElementById('addEntryForPersonForm');
        const amountForPersonInput = document.getElementById('amountForPerson');
        const transactionTypeForPersonSelect = document.getElementById('transactionTypeForPerson');
        const notesForPersonTextarea = document.getElementById('notesForPerson');
        const entryForPersonMessageDiv = document.getElementById('entryForPersonMessage');
        const personTransactionsListDiv = document.getElementById('personTransactionsList');

        let unsubscribeFromPersonTransactions = null; // Listener for specific person's transactions

        function openPersonDetailsModal(personName) {
            personDetailsNameHeader.textContent = personName;
            personDetailsModalPersonNameInput.value = personName; // Hidden input to store person name
            addEntryForPersonNameSpan.textContent = personName; // For the "Add New Entry for [Person Name]" title

            // Clear previous messages and form
            hideMessage('entryForPersonMessage');
            addEntryForPersonForm.reset();

            personDetailsModal.classList.add('active');
            
            // Set up real-time listener for this person's transactions
            const user = auth.currentUser;
            if (user) {
                if (unsubscribeFromPersonTransactions) {
                    unsubscribeFromPersonTransactions(); // Unsubscribe from previous if exists
                }

                unsubscribeFromPersonTransactions = db.collection('users').doc(user.uid).collection('khatabook')
                    .where('personName', '==', personName) // Filter by personName
                    .orderBy('timestamp', 'desc') // Order by descending for newest entries first
                    .onSnapshot(snapshot => {
                        personTransactionsListDiv.innerHTML = ''; // Clear previous list
                        if (snapshot.empty) {
                            personTransactionsListDiv.innerHTML = '<p class="no-entries">No transactions with this person yet.</p>';
                            
                            // Also check if the person exists in dashboard
                            const personItemStillExists = Array.from(document.querySelectorAll('.person-item')).some(item =>
                                item.textContent.includes(personName)
                            );

                            if (!personItemStillExists) {
                                // Person was deleted, close the modal
                                personDetailsModal.classList.remove('active');
                                unsubscribeFromPersonTransactions?.();
                                unsubscribeFromPersonTransactions = null;
                            }
                            return;
                        }

                        let currentBalance = 0;
                        const allTransactions = [];
                        snapshot.forEach(doc => {
                            allTransactions.push({ id: doc.id, ...doc.data() });
                        });

                        // Calculate running balance in correct order (oldest to newest) for display
                        // This requires reversing the array for balance calculation if sorted desc for display
                        const transactionsForBalanceCalc = [...allTransactions].reverse();
                        const runningBalances = new Map();
                        transactionsForBalanceCalc.forEach(entry => {
                            if (entry.transactionType === 'lent') {
                                currentBalance += entry.amount;
                            } else if (entry.transactionType === 'borrowed') {
                                currentBalance -= entry.amount;
                            }
                            runningBalances.set(entry.id, currentBalance);
                        });

                        let lastDate = ''; // To track date for separator

                        // Now iterate through transactions (already sorted desc for display)
                        allTransactions.forEach(entry => {
                            const entryId = entry.id;
                            const amount = entry.amount;
                            const transactionType = entry.transactionType;
                            const notes = entry.notes || ''; // Ensure notes is not null
                            const timestampDate = entry.timestamp ? entry.timestamp.toDate() : new Date();

                            // Get the calculated running balance for this specific entry
                            const displayBalance = runningBalances.get(entryId);

                            // Format date for separator (e.g., "07 Jul 25")
                            const dateOptions = { day: '2-digit', month: 'short', year: '2-digit' };
                            const formattedDateForSeparator = timestampDate.toLocaleDateString('en-IN', dateOptions).replace(/\//g, ' '); // Format to "DD Mon YY"

                            // Format date and time for individual transaction row (e.g., "HH:MM AM/PM, DD Mon YY")
                            const datetimeOptions = { year: '2-digit', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true };
                            const formattedDateTime = timestampDate.toLocaleDateString('en-IN', datetimeOptions);

                            // Add date separator if date changes
                            if (formattedDateForSeparator !== lastDate) {
                                const dateSeparatorDiv = document.createElement('div');
                                dateSeparatorDiv.classList.add('date-separator');
                                dateSeparatorDiv.textContent = formattedDateForSeparator; // Only date for separator
                                personTransactionsListDiv.appendChild(dateSeparatorDiv);
                                lastDate = formattedDateForSeparator;
                            }

                            const transactionRowDiv = document.createElement('div');
                            transactionRowDiv.classList.add('transaction-row');
                            transactionRowDiv.dataset.id = entryId;
                            
                            // Encode values for passing to onclick
                            const encodedPersonName = encodeURIComponent(personName);
                            const encodedNotes = encodeURIComponent(notes);

                            // Add onclick handler to the row
                            transactionRowDiv.setAttribute('onclick', `openEditModal('${entryId}', '${encodedPersonName}', ${amount}, '${transactionType}', '${encodedNotes}')`);

                            // Determine balance class and description for display
                            let balanceClass = '';
                            let balanceDescription = '';
                            if (displayBalance > 0) { // If I lent more than I borrowed (I will get money back)
                                balanceClass = 'lent';
                                balanceDescription = 'You will get';
                            } else if (displayBalance < 0) { // If I borrowed more than I lent (I will give money)
                                balanceClass = 'borrowed';
                                balanceDescription = 'You will give';
                            } else { // Balance is 0
                                balanceClass = 'settled';
                                balanceDescription = 'Settled';
                            }

                            // --- MODIFIED: Remove auto notes if not provided ---
                            const displayNotes = notes.length > 0 ? notes : ''; // Show notes only if explicitly provided

                            transactionRowDiv.innerHTML = `
                                <div class="entries-col">
                                    <div class="balance-info">
                                        Bal. ₹ <span class="running-balance ${balanceClass}">${Math.abs(displayBalance).toFixed(0)}</span>
                                        ${balanceDescription ? `(${balanceDescription})` : ''}
                                    </div>
                                    <div class="transaction-description">${displayNotes}</div>
                                    <span class="transaction-datetime">${formattedDateTime}</span>
                                </div>
                                <div class="you-gave-col">
                                    ${transactionType === 'lent' ? `₹ ${amount.toFixed(0)}` : ''}
                                </div>
                                <div class="you-got-col">
                                    ${transactionType === 'borrowed' ? `₹ ${amount.toFixed(0)}` : ''}
                                </div>
                            `;
                            personTransactionsListDiv.appendChild(transactionRowDiv);
                        });
                    }, error => {
                        console.error('Error loading person transactions in real-time:', error.message);
                        showMessage('entryForPersonMessage', `Failed to load transactions: ${error.message}`, 'error');
                    });
            }
        }

        if (closePersonDetailsModalButton) {
            closePersonDetailsModalButton.onclick = function() {
                personDetailsModal.classList.remove('active');
                if (unsubscribeFromPersonTransactions) {
                    unsubscribeFromPersonTransactions(); // Unsubscribe when modal closes
                    unsubscribeFromPersonTransactions = null;
                }
            }
        }

        // Close person details modal if clicked outside content
        window.addEventListener('click', function(event) {
            if (event.target == personDetailsModal) {
                personDetailsModal.classList.remove('active');
                if (unsubscribeFromPersonTransactions) {
                    unsubscribeFromPersonTransactions(); // Unsubscribe when modal closes
                    unsubscribeFromPersonTransactions = null;
                }
            }
        });

        // Handle Add Entry form submission within Person Details Modal
        if (addEntryForPersonForm) {
            addEntryForPersonForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const personName = personDetailsModalPersonNameInput.value; // Get name from hidden input
                const amount = parseFloat(amountForPersonInput.value);
                const transactionType = transactionTypeForPersonSelect.value;
                const notes = notesForPersonTextarea.value.trim();
                hideMessage('entryForPersonMessage');

                if (isNaN(amount) || amount <= 0) {
                    showMessage('entryForPersonMessage', 'Please enter a valid positive amount.', 'error');
                    return;
                }

                const user = auth.currentUser;
                if (user) {
                    try {
                        await db.collection('users').doc(user.uid).collection('khatabook').add({
                            personName: personName,
                            amount: amount,
                            transactionType: transactionType,
                            notes: notes,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showMessage('entryForPersonMessage', 'Entry added successfully!', 'success');
                        addEntryForPersonForm.reset();
                        // Real-time listener for person's transactions will update automatically
                    } catch (error) {
                        console.error('Error adding entry for person:', error.message);
                        showMessage('entryForPersonMessage', `Failed to add entry: ${error.message}`, 'error');
                    }
                } else {
                    showMessage('entryForPersonMessage', 'You must be logged in to add entries.', 'error');
                }
            });
        }
    </script>
</body>
</html>
