<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Khatabook - All in One</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- General Variables & Resets --- */
        :root {
            --primary-color: #4CAF50; /* Green from original Khatabook logo */
            --primary-dark: #388E3C;
            --secondary-color: #FFC107; /* Amber for accents */
            --success-color: #28a745;
            --danger-color: #dc3545;
            --text-dark: #333;
            --text-light: #666;
            --bg-light: #f4f7f6;
            --bg-medium: #e9ecef;
            --card-bg: #ffffff;
            --border-color: #ddd;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden; /* Prevent horizontal scroll from animations */
            min-height: 100vh; /* Ensure body takes full height */
            display: flex; /* Use flex for app-container */
            flex-direction: column; /* Allow content to stack */
        }

        /* --- Global Container & Page Transitions --- */
        .app-container {
            flex-grow: 1; /* Allow container to fill available height */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top instead of center for dashboard */
            padding: 20px;
            overflow: auto; /* Allow scrolling within the container */
        }

        .page-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-medium);
            padding: 40px;
            width: 100%;
            max-width: 500px; /* Default max-width for auth sections */
            text-align: center;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            display: none; /* Hidden by default, shown by JS */
            opacity: 0;
            margin: 20px auto; /* Add margin for spacing */
        }

        .page-section.active {
            display: block;
            opacity: 1;
            animation: fadeInScale 0.6s ease-out forwards;
        }

        .page-section:not(.active) {
            animation: fadeOutScale 0.4s ease-in forwards;
            pointer-events: none; /* Prevent interaction while fading out */
        }

        /* Fixed Responsive Centering for Auth Sections */
#login-section.active,
#signup-section.active,
#forgot-password-section.active {
    position: relative;
    margin: auto;
    top: unset;
    left: unset;
    transform: none;
    max-height: none;
    overflow: visible;
    padding: 30px 20px;
    display: block;
}
        #login-section, #signup-section, #forgot-password-section {
             background-color: var(--card-bg);
             max-width: 450px;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes fadeOutScale {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        /* --- Headings --- */
        h1 {
            font-size: 2.5em;
            color: var(--primary-dark);
            margin-bottom: 20px;
            font-weight: 700;
        }

        h2 {
            font-size: 2em;
            color: var(--primary-color);
            margin-bottom: 30px;
            font-weight: 600;
        }

        h3 {
            font-size: 1.5em;
            color: var(--text-dark);
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* --- Form Styles --- */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }

        input[type="email"],
        input[type="password"],
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background-color: var(--bg-light);
            transition: all 0.3s ease;
        }

        input[type="email"]:focus,
        input[type="password"]:focus,
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
            outline: none;
            background-color: white;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: var(--text-light);
            font-size: 0.85em;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* --- Buttons --- */
        .btn {
            display: inline-block;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 600;
            margin-top: 10px; /* Default margin for buttons */
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--secondary-color);
            color: var(--text-dark);
        }

        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }
        .btn-info { /* New button style for View Details */
            background-color: #17a2b8;
            color: white;
        }
        .btn-info:hover {
            background-color: #138496;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn + .btn {
            margin-left: 10px;
        }

        /* --- Links --- */
        p {
            margin-top: 20px;
            font-size: 0.95em;
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        a:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }

        /* --- Message Display --- */
        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.95em;
            display: none;
            animation: fadeIn 0.5s forwards;
            font-weight: 500;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Dashboard Header --- */
        .dashboard-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-light);
            border-radius: 10px;
            margin-bottom: 25px;
            animation: slideInFromTop 0.8s ease-out forwards;
        }

        @keyframes slideInFromTop {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-header h1 {
            font-size: 1.8em;
            margin: 0;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            font-weight: 500;
            font-size: 1.1em;
        }

        /* --- Dashboard Main Content --- */
        .dashboard-main {
            max-width: 1000px; /* Wider dashboard for more content */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
            animation: fadeIn 1s ease-out forwards;
            padding-bottom: 20px; /* Add some padding at the bottom */
        }

        /* Specific styles for dashboard section, override default .page-section */
        #dashboard-section {
            max-width: 1000px; /* Wider than auth sections */
            padding: 20px; /* Adjust padding if needed */
            text-align: left; /* Align dashboard content left */
            position: static; /* Remove absolute positioning */
            transform: none; /* Remove transform */
            margin: 0 auto; /* Center it horizontally */
            width: calc(100% - 40px); /* Account for app-container padding */
        }


        /* --- Summary Cards --- */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: var(--shadow-light);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }

        .card h3 {
            margin-bottom: 12px;
            font-size: 1.2em;
            color: var(--text-light);
        }

        .card .amount-display {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--text-dark);
        }

        .lent-card .amount-display {
            color: var(--success-color);
        }

        .borrowed-card .amount-display {
            color: var(--danger-color);
        }

        /* --- Sections for Add Entry & People Summary --- */
        .add-entry-section,
        .people-summary-section,
        .entry-list-section { /* Added entry-list-section for modal */
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
        }

        .add-entry-section h3,
        .people-summary-section h3,
        .entry-list-section h3 { /* Added for modal entry list */
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-dark);
        }
        .add-entry-section.compact { /* For add entry form inside modal */
            padding: 20px;
            box-shadow: none;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .add-entry-section form .btn {
            width: 100%;
        }

        /* --- People Summary List Styles --- */
        .people-list { /* New list for people */
            list-style: none;
            padding: 0;
        }

        .person-item {
            background-color: var(--bg-medium);
            border: 1px solid var(--border-color);
            padding: 15px 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .person-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .person-details {
            flex-grow: 1;
            text-align: left;
        }

        .person-details strong {
            font-size: 1.2em;
            color: var(--text-dark);
        }

        .person-details .net-balance {
            font-weight: 700;
            font-size: 1.3em;
            margin-left: 8px;
        }
        .person-details .net-balance.lent {
            color: var(--success-color);
        }
        .person-details .net-balance.borrowed {
            color: var(--danger-color);
        }

        .person-details small {
            display: block;
            color: var(--text-light);
            margin-top: 5px;
            font-size: 0.85em;
        }

        .person-actions {
            display: flex;
            gap: 8px;
        }

        .person-actions .btn {
            padding: 8px 15px;
            font-size: 0.85em;
            margin-top: 0;
        }

        .no-entries { /* Reused for no people */
            text-align: center;
            color: var(--text-light);
            font-style: italic;
            padding: 20px;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            margin-top: 20px;
        }

        /* --- Transaction List within Modal --- */
        .transaction-list {
            list-style: none;
            padding: 0;
        }
        .transaction-item {
            background-color: var(--bg-medium);
            border: 1px solid var(--border-color);
            padding: 15px 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .transaction-item.lent {
            border-left: 6px solid var(--success-color);
        }

        .transaction-item.borrowed {
            border-left: 6px solid var(--danger-color);
        }

        .transaction-details {
            flex-grow: 1;
            text-align: left;
        }

        .transaction-details strong {
            font-size: 1.1em;
            color: var(--text-dark);
        }

        .transaction-details .entry-amount {
            font-weight: 700;
            font-size: 1.3em;
            margin-left: 8px;
        }

        .transaction-details .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 700;
            margin-left: 10px;
            text-transform: uppercase;
        }

        .transaction-details .type-badge.lent {
            background-color: #d4edda; /* Light green */
            color: #155724; /* Dark green */
        }

        .transaction-details .type-badge.borrowed {
            background-color: #f8d7da; /* Light red */
            color: #721c24; /* Dark red */
        }

        .transaction-details small {
            display: block;
            color: var(--text-light);
            margin-top: 5px;
            font-size: 0.85em;
        }

        .transaction-actions {
            display: flex;
            gap: 8px;
        }

        .transaction-actions .btn {
            padding: 8px 15px;
            font-size: 0.85em;
            margin-top: 0; /* Override default button margin */
        }


        /* --- Modal Styles --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            background-color: rgba(0,0,0,0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

#editModal {
    z-index: 1100 !important; /* Higher than personDetailsModal */
}

#editModal .modal-content {
    position: relative;
    z-index: 1101;
}

        .modal.active {
            display: flex;
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-medium);
            width: 90%;
            max-width: 550px;
            position: relative;
            transform: translateY(-20px); /* Initial position for animation */
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-height: 90vh; /* Limit modal height */
            overflow-y: auto; /* Enable scroll for modal content */
        }

        .modal.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .close-button {
            color: var(--text-light);
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--danger-color);
        }

        .modal h2 {
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        .modal form .btn {
            margin-top: 25px;
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            .app-container {
                padding: 10px; /* Reduced padding for very small screens */
            }

            .page-section {
                padding: 25px 20px; /* Adjusted padding */
                max-width: 100%; /* Use full width */
                margin: 10px auto; /* Smaller margin */
            }

            #dashboard-section {
                padding: 15px; /* Adjust padding for dashboard section */
                width: 100%;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                padding: 15px 20px;
                border-radius: 8px; /* Slightly smaller border radius */
            }
            .dashboard-header h1 {
                font-size: 1.5em;
            }
            .user-info {
                flex-direction: column;
                gap: 5px;
                font-size: 0.9em;
            }

            .summary-cards {
                grid-template-columns: 1fr; /* Stack cards on small screens */
                gap: 15px; /* Smaller gap */
            }

            .card {
                padding: 20px; /* Adjust card padding */
            }
            .card .amount-display {
                font-size: 2em; /* Smaller amount font size */
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }
            .form-row .form-group {
                margin-bottom: 15px;
            }

            .person-item, .transaction-item { /* Adjusted for person-item and transaction-item */
                flex-direction: column;
                align-items: flex-start;
                padding: 12px; /* Smaller padding */
            }
            .person-details, .transaction-details { /* Adjusted for details */
                margin-bottom: 8px; /* Smaller margin */
                width: 100%;
            }
            .person-details strong, .transaction-details strong {
                font-size: 1em;
            }
            .person-details .net-balance, .transaction-details .entry-amount {
                font-size: 1.1em;
            }
            .person-actions, .transaction-actions {
                width: 100%;
                justify-content: flex-end;
            }
            .person-actions .btn, .transaction-actions .btn {
                padding: 6px 10px;
                font-size: 0.75em;
            }
            .modal-content {
                padding: 20px; /* Smaller modal padding */
            }
            .close-button {
                font-size: 24px;
                top: 10px;
                right: 15px;
            }
            .modal h2 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>

    <div class="app-container">

        <div id="login-section" class="page-section">
            <h2>Login to My Khatabook</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
            <p>Don't have an account? <a href="#" onclick="showSection('signup-section'); return false;">Sign Up</a></p>
            <p><a href="#" onclick="showSection('forgot-password-section'); return false;">Forgot Password?</a></p>
            <div id="loginMessage" class="message"></div>
        </div>

        <div id="signup-section" class="page-section">
            <h2>Create Your Khatabook Account</h2>
            <form id="signupForm">
                <div class="form-group">
                    <label for="signupEmail">Email:</label>
                    <input type="email" id="signupEmail" placeholder="Enter your email" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password:</label>
                    <input type="password" id="signupPassword" placeholder="Choose a password" required autocomplete="new-password">
                    <small>Minimum 6 characters</small>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password:</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm your password" required autocomplete="new-password">
                </div>
                <button type="submit" class="btn btn-primary">Sign Up</button>
            </form>
            <p>Already have an account? <a href="#" onclick="showSection('login-section'); return false;">Login</a></p>
            <div id="signupMessage" class="message"></div>
        </div>

        <div id="forgot-password-section" class="page-section">
            <h2>Forgot Password</h2>
            <p>Enter your email address to receive a password reset link.</p>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label for="resetEmail">Email:</label>
                    <input type="email" id="resetEmail" placeholder="Enter your email" required autocomplete="username">
                </div>
                <button type="submit" class="btn btn-primary">Reset Password</button>
            </form>
            <p><a href="#" onclick="showSection('login-section'); return false;">Back to Login</a></p>
            <div id="forgotPasswordMessage" class="message"></div>
        </div>

        <div id="dashboard-section" class="page-section">
            <div class="dashboard-header">
                <h1>My Khatabook</h1>
                <div class="user-info">
                    <span id="userEmailDisplay"></span>
                    <button id="logoutButton" class="btn btn-danger">Logout</button>
                </div>
            </div>

            <div class="dashboard-main">
                <div class="summary-cards">
                    <div class="card lent-card">
                        <h3>You Lent (Given)</h3>
                        <p class="amount-display" id="totalLent">₹ 0.00</p>
                    </div>
                    <div class="card borrowed-card">
                        <h3>You Borrowed (Taken)</h3>
                        <p class="amount-display" id="totalBorrowed">₹ 0.00</p>
                    </div>
                </div>

                <div class="add-entry-section">
                    <h3>Add New Entry</h3>
                    <form id="addEntryForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="personName">Person Name:</label>
                                <input type="text" id="personName" placeholder="e.g., John Doe" required>
                            </div>
                            <div class="form-group">
                                <label for="amount">Amount (₹):</label>
                                <input type="number" id="amount" placeholder="e.g., 500" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="transactionType">Type:</label>
                                <select id="transactionType" required>
                                    <option value="lent">You Lent (Given)</option>
                                    <option value="borrowed">You Borrowed (Taken)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="notes">Notes (Optional):</label>
                                <textarea id="notes" placeholder="Any specific details"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Entry</button>
                    </form>
                    <div id="entryMessage" class="message"></div>
                </div>

                <div class="people-summary-section">
                    <h3>People Summary</h3>
                    <div id="peopleSummaryList">
                        </div>
                </div>
            </div>
        </div>

        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeEditModalButton">&times;</span>
                <h2>Edit Entry</h2>
                <form id="editEntryForm">
                    <input type="hidden" id="editEntryId">
                    <div class="form-group">
                        <label for="editPersonName">Person Name:</label>
                        <input type="text" id="editPersonName" required>
                    </div>
                    <div class="form-group">
                        <label for="editAmount">Amount (₹):</label>
                        <input type="number" id="editAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="editTransactionType">Type:</label>
                        <select id="editTransactionType" required>
                            <option value="lent">You Lent (Given)</option>
                            <option value="borrowed">You Borrowed (Taken)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editNotes">Notes (Optional):</label>
                        <textarea id="editNotes"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Entry</button>
                </form>
                <div id="editMessage" class="message"></div>
            </div>
        </div>

        <div id="personDetailsModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closePersonDetailsModalButton">&times;</span>
                <h2 id="personDetailsName"></h2>

                <div class="add-entry-section compact">
                    <h3>Add New Entry for <span id="addEntryForPersonName"></span></h3>
                    <form id="addEntryForPersonForm">
                        <input type="hidden" id="personDetailsModalPersonName">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="amountForPerson">Amount (₹):</label>
                                <input type="number" id="amountForPerson" placeholder="e.g., 500" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="transactionTypeForPerson">Type:</label>
                                <select id="transactionTypeForPerson" required>
                                    <option value="lent">You Lent (Given)</option>
                                    <option value="borrowed">You Borrowed (Taken)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="notesForPerson">Notes (Optional):</label>
                                <textarea id="notesForPerson" placeholder="Any specific details"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Entry</button>
                    </form>
                    <div id="entryForPersonMessage" class="message"></div>
                </div>

                <div class="entry-list-section">
                    <h3>Transaction History</h3>
                    <div id="personTransactionsList">
                        </div>
                </div>
            </div>
        </div>

    </div>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

    <script>
        // Your Firebase Configuration (GET THIS FROM FIREBASE CONSOLE)
        // Go to Firebase Console -> Project settings -> Your apps -> Web app
        const firebaseConfig = {
            apiKey: "AIzaSyCFnD9Xt20WKGOtY_S5s3CchvCtRInL2bQ",
            authDomain: "our-khata.firebaseapp.com",
            projectId: "our-khata",
            storageBucket: "our-khata.firebasestorage.app",
            messagingSenderId: "762914243450",
            appId: "1:762914243450:web:a5dc0b9eaf98dbfa86ccc3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- UI Helper Functions ---
        function showMessage(elementId, message, type) {
            const messageElement = document.getElementById(elementId);
            if (messageElement) {
                messageElement.textContent = message;
                messageElement.className = `message ${type}`;
                messageElement.style.display = 'block';
                setTimeout(() => {
                    hideMessage(elementId);
                }, 5000);
            }
        }

        function hideMessage(elementId) {
            const messageElement = document.getElementById(elementId);
            if (messageElement) {
                messageElement.style.display = 'none';
            }
        }

        function showSection(sectionId) {
            const sections = document.querySelectorAll('.page-section');
            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
        }

        // --- Auth State Listener (handles page switching) ---
        let initialLoad = true;
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is logged in
                showSection('dashboard-section');
                const userEmailDisplay = document.getElementById('userEmailDisplay');
                if (userEmailDisplay) {
                    userEmailDisplay.textContent = user.email;
                }
                if (initialLoad) {
                    loadDashboardData(user.uid); // Load initial data on first login
                    initialLoad = false;
                }
            } else {
                // User is NOT logged in
                showSection('login-section'); // Default to login page
                initialLoad = true; // Reset for next login
            }
        });

        // --- Authentication Logic ---

        // Login Form
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginForm['loginEmail'].value;
                const password = loginForm['loginPassword'].value;
                hideMessage('loginMessage');

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    showMessage('loginMessage', 'Login successful! Redirecting...', 'success');
                    // showSection('dashboard-section') is handled by auth.onAuthStateChanged
                } catch (error) {
                    console.error('Login error:', error.message);
                    showMessage('loginMessage', `Login failed: ${error.message}`, 'error');
                }
            });
        }

        // Signup Form
        const signupForm = document.getElementById('signupForm');
        if (signupForm) {
            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = signupForm['signupEmail'].value;
                const password = signupForm['signupPassword'].value;
                const confirmPassword = signupForm['confirmPassword'].value;
                hideMessage('signupMessage');

                if (password.length < 6) {
                    showMessage('signupMessage', 'Password must be at least 6 characters long.', 'error');
                    return;
                }
                if (password !== confirmPassword) {
                    showMessage('signupMessage', 'Passwords do not match.', 'error');
                    return;
                }

                try {
                    await auth.createUserWithEmailAndPassword(email, password);
                    showMessage('signupMessage', 'Account created successfully! Redirecting to login...', 'success');
                    setTimeout(() => {
                        showSection('login-section');
                    }, 2000);
                } catch (error) {
                    console.error('Signup error:', error.message);
                    showMessage('signupMessage', `Signup failed: ${error.message}`, 'error');
                }
            });
        }

        // Forgot Password Form
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        if (forgotPasswordForm) {
            forgotPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = forgotPasswordForm['resetEmail'].value;
                hideMessage('forgotPasswordMessage');

                try {
                    await auth.sendPasswordResetEmail(email);
                    showMessage('forgotPasswordMessage', 'Password reset email sent! Check your inbox.', 'success');
                } catch (error) {
                    console.error('Forgot password error:', error.message);
                    showMessage('forgotPasswordMessage', `Failed to send reset email: ${error.message}`, 'error');
                }
            });
        }

        // Logout Button
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                    console.log('User logged out.');
                    // auth.onAuthStateChanged will handle showing login section
                } catch (error) {
                    console.error('Logout error:', error.message);
                    alert('Failed to log out. Please try again.');
                }
            });
        }

        // --- Dashboard Logic ---

        // Add Khatabook Entry Form (General for new or existing people)
        const addEntryForm = document.getElementById('addEntryForm');
        if (addEntryForm) {
            addEntryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const personName = addEntryForm['personName'].value.trim();
                const amount = parseFloat(addEntryForm['amount'].value);
                const transactionType = addEntryForm['transactionType'].value;
                const notes = addEntryForm['notes'].value.trim();
                hideMessage('entryMessage');

                if (!personName) {
                    showMessage('entryMessage', 'Person Name cannot be empty.', 'error');
                    return;
                }
                if (isNaN(amount) || amount <= 0) {
                    showMessage('entryMessage', 'Please enter a valid positive amount.', 'error');
                    return;
                }

                const user = auth.currentUser;
                if (user) {
                    try {
                        await db.collection('users').doc(user.uid).collection('khatabook').add({
                            personName: personName,
                            amount: amount,
                            transactionType: transactionType,
                            notes: notes,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showMessage('entryMessage', 'Entry added successfully!', 'success');
                        addEntryForm.reset();
                        // Real-time listener loadDashboardData will update
                    } catch (error) {
                        console.error('Error adding entry:', error.message);
                        showMessage('entryMessage', `Failed to add entry: ${error.message}`, 'error');
                    }
                } else {
                    showMessage('entryMessage', 'You must be logged in to add entries.', 'error');
                }
            });
        }

        // Real-time Load Dashboard Data (Summary Cards + People Summary)
        let unsubscribeFromKhatabook = null;

        function loadDashboardData(uid) {
            const peopleSummaryListDiv = document.getElementById('peopleSummaryList');
            const totalLentDisplay = document.getElementById('totalLent');
            const totalBorrowedDisplay = document.getElementById('totalBorrowed');

            if (!peopleSummaryListDiv || !totalLentDisplay || !totalBorrowedDisplay) return;

            // Unsubscribe from previous listener if it exists
            if (unsubscribeFromKhatabook) {
                unsubscribeFromKhatabook();
            }

            unsubscribeFromKhatabook = db.collection('users').doc(uid).collection('khatabook')
                .orderBy('timestamp', 'desc') // We need all entries to calculate totals and last activity per person
                .onSnapshot(snapshot => {
                    let totalLentOverall = 0;
                    let totalBorrowedOverall = 0;
                    const peopleData = {}; // To aggregate data per person

                    if (snapshot.empty) {
                        peopleSummaryListDiv.innerHTML = '<p class="no-entries">No entries yet. Add your first transaction!</p>';
                        totalLentDisplay.textContent = '₹ 0.00';
                        totalBorrowedDisplay.textContent = '₹ 0.00';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const entry = doc.data();
                        const personName = entry.personName;
                        const amount = entry.amount;
                        const transactionType = entry.transactionType;
                        // Firestore Timestamp objects need .toDate() to be converted to JS Date objects
                        const timestamp = entry.timestamp ? entry.timestamp.toDate() : new Date(0); // Use a default old date if timestamp is missing

                        // Update overall totals
                        if (transactionType === 'lent') {
                            totalLentOverall += amount;
                        } else if (transactionType === 'borrowed') {
                            totalBorrowedOverall += amount;
                        }

                        // Aggregate data for people summary
                        if (!peopleData[personName]) {
                            peopleData[personName] = {
                                lent: 0,
                                borrowed: 0,
                                lastActivity: timestamp // Initialize with first transaction's timestamp
                            };
                        }

                        if (transactionType === 'lent') {
                            peopleData[personName].lent += amount;
                        } else if (transactionType === 'borrowed') {
                            peopleData[personName].borrowed += amount;
                        }

                        // Update last activity for this person
                        if (timestamp > peopleData[personName].lastActivity) {
                            peopleData[personName].lastActivity = timestamp;
                        }
                    });

                    // Update overall summary cards
                    totalLentDisplay.textContent = `₹ ${totalLentOverall.toFixed(2)}`;
                    totalBorrowedDisplay.textContent = `₹ ${totalBorrowedOverall.toFixed(2)}`;

                    // Render People Summary
                    peopleSummaryListDiv.innerHTML = ''; // Clear previous list
                    const ul = document.createElement('ul');
                    ul.classList.add('people-list');

                    const sortedPeople = Object.keys(peopleData).sort((a, b) => {
                        // Sort by last activity descending
                        return peopleData[b].lastActivity.getTime() - peopleData[a].lastActivity.getTime();
                    });

                    sortedPeople.forEach(personName => {
                        const data = peopleData[personName];
                        const netBalance = data.lent - data.borrowed;
                        let balanceText = `₹ ${Math.abs(netBalance).toFixed(2)}`;
                        let balanceClass = '';

                        if (netBalance > 0) {
                            balanceText += ' You Lent';
                            balanceClass = 'lent';
                        } else if (netBalance < 0) {
                            balanceText += ' You Borrowed';
                            balanceClass = 'borrowed';
                        } else {
                            balanceText = '₹ 0.00 Settled';
                        }

                        const listItem = document.createElement('li');
                        listItem.classList.add('person-item');
                        listItem.innerHTML = `
                            <div class="person-details">
                                <strong>${personName}</strong>: <span class="net-balance ${balanceClass}">${balanceText}</span>
                                <small>Last activity: ${data.lastActivity.toLocaleString()}</small>
                            </div>
                            <div class="person-actions">
                                <button class="btn btn-info" onclick="openPersonDetailsModal(decodeURIComponent('${encodeURIComponent(personName)}'))">View Details</button>
                            </div>
                        `;
                        ul.appendChild(listItem);
                    });
                    peopleSummaryListDiv.appendChild(ul);

                }, error => {
                    console.error('Error loading dashboard data in real-time:', error.message);
                    showMessage('entryMessage', `Failed to load dashboard: ${error.message}`, 'error');
                });
        }


        // --- Edit Modal Logic (Existing) ---
        const editModal = document.getElementById('editModal');
        const closeEditModalButton = document.getElementById('closeEditModalButton');
        const editEntryForm = document.getElementById('editEntryForm');
        const editEntryIdInput = document.getElementById('editEntryId');
        const editPersonNameInput = document.getElementById('editPersonName');
        const editAmountInput = document.getElementById('editAmount');
        const editTransactionTypeInput = document.getElementById('editTransactionType');
        const editNotesInput = document.getElementById('editNotes');

        function openEditModal(id, name, amount, type, notes) {
document.getElementById('personDetailsModal')?.classList.remove('active');
            editEntryIdInput.value = id;
            editPersonNameInput.value = decodeURIComponent(name); // Decode here
            editAmountInput.value = amount;
            editTransactionTypeInput.value = type;
            editNotesInput.value = decodeURIComponent(notes); // Decode here
            hideMessage('editMessage');
            editModal.classList.add('active'); // Use class for modal visibility
        }

        if (closeEditModalButton) {
            closeEditModalButton.onclick = function() {
                editModal.classList.remove('active');
            }
        }

        // Close edit modal if clicked outside content
        window.addEventListener('click', function(event) {
            if (event.target == editModal) {
                editModal.classList.remove('active');
            }
        });

        // Handle update form submission
        if (editEntryForm) {
            editEntryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const entryId = editEntryIdInput.value;
                const newPersonName = editPersonNameInput.value.trim();
                const newAmount = parseFloat(editAmountInput.value);
                const newTransactionType = editTransactionTypeInput.value;
                const newNotes = editNotesInput.value.trim();
                hideMessage('editMessage');

                if (!newPersonName) {
                    showMessage('editMessage', 'Person Name cannot be empty.', 'error');
                    return;
                }
                if (isNaN(newAmount) || newAmount <= 0) {
                    showMessage('editMessage', 'Please enter a valid positive amount.', 'error');
                    return;
                }

                const user = auth.currentUser;
                if (user) {
                    try {
                        await db.collection('users').doc(user.uid).collection('khatabook').doc(entryId).update({
                            personName: newPersonName,
                            amount: newAmount,
                            transactionType: newTransactionType,
                            notes: newNotes,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp() // Update timestamp on edit
                        });
                        showMessage('editMessage', 'Entry updated successfully!', 'success');
                        editModal.classList.remove('active'); // Close modal
                        // Due to onSnapshot listeners, dashboard and person details will auto-update
                    } catch (error) {
                        console.error('Error updating entry:', error.message);
                        showMessage('editMessage', `Failed to update entry: ${error.message}`, 'error');
                    }
                }
            });
        }

        // Delete Entry
        async function deleteEntry(id) {
            if (confirm("Are you sure you want to delete this entry? This action cannot be undone.")) {
                const user = auth.currentUser;
                if (user) {
                    try {
    await db.collection('users').doc(user.uid).collection('khatabook').doc(id).delete();
    showMessage('entryMessage', 'Entry deleted successfully!', 'success');

    // ⏳ Wait for Firestore to update, then check person still exists
    setTimeout(() => {
        const currentPerson = personDetailsModalPersonNameInput.value;
        const stillExists = Array.from(document.querySelectorAll('.person-item')).some(item =>
            item.textContent.includes(currentPerson)
        );

        if (!stillExists) {
            // Person no longer exists, close modal
            personDetailsModal.classList.remove('active');
            if (unsubscribeFromPersonTransactions) {
                unsubscribeFromPersonTransactions();
                unsubscribeFromPersonTransactions = null;
            }
        } else {
            refreshPersonTransactions();
        }
    }, 300);
} catch (error) {
                        console.error('Error deleting entry:', error.message);
                        showMessage('entryMessage', `Failed to delete entry: ${error.message}`, 'error');
                    }
                } else {
                    showMessage('entryMessage', 'You must be logged in to delete entries.', 'error');
                }
            }
        }

        // --- Person Details Modal Logic ---
        const personDetailsModal = document.getElementById('personDetailsModal');
        const closePersonDetailsModalButton = document.getElementById('closePersonDetailsModalButton');
        const personDetailsNameHeader = document.getElementById('personDetailsName');
        const personDetailsModalPersonNameInput = document.getElementById('personDetailsModalPersonName');
        const addEntryForPersonNameSpan = document.getElementById('addEntryForPersonName');
        const addEntryForPersonForm = document.getElementById('addEntryForPersonForm');
        const amountForPersonInput = document.getElementById('amountForPerson');
        const transactionTypeForPersonSelect = document.getElementById('transactionTypeForPerson');
        const notesForPersonTextarea = document.getElementById('notesForPerson');
        const entryForPersonMessageDiv = document.getElementById('entryForPersonMessage');
        const personTransactionsListDiv = document.getElementById('personTransactionsList');

        let unsubscribeFromPersonTransactions = null; // Listener for specific person's transactions

        function openPersonDetailsModal(personName) {
            personDetailsNameHeader.textContent = personName;
            personDetailsModalPersonNameInput.value = personName; // Hidden input to store person name
            addEntryForPersonNameSpan.textContent = personName; // For the "Add New Entry for [Person Name]" title

            // Clear previous messages and form
            hideMessage('entryForPersonMessage');
            addEntryForPersonForm.reset();

            personDetailsModal.classList.add('active');
            
            // Set up real-time listener for this person's transactions
            const user = auth.currentUser;
            if (user) {
                if (unsubscribeFromPersonTransactions) {
                    unsubscribeFromPersonTransactions(); // Unsubscribe from previous if exists
                }

                unsubscribeFromPersonTransactions = db.collection('users').doc(user.uid).collection('khatabook')
                    .where('personName', '==', personName) // Filter by personName
                    .orderBy('timestamp', 'desc')
                    .onSnapshot(snapshot => {
                        personTransactionsListDiv.innerHTML = ''; // Clear previous list
                        if (snapshot.empty) {
    personTransactionsListDiv.innerHTML = '<p class="no-entries">No transactions with this person yet.</p>';
    
    // Also check if the person exists in dashboard
    const personItemStillExists = Array.from(document.querySelectorAll('.person-item'))
        .some(item => item.textContent.includes(personName));

    if (!personItemStillExists) {
        // Person was deleted, close the modal
        personDetailsModal.classList.remove('active');
        unsubscribeFromPersonTransactions?.();
        unsubscribeFromPersonTransactions = null;
    }

    return;
}

                        const ul = document.createElement('ul');
                        ul.classList.add('transaction-list');
                        snapshot.forEach(doc => {
                            const entry = doc.data();
                            const entryId = doc.id;
                            const timestampDate = entry.timestamp ? new Date(entry.timestamp.toDate()).toLocaleString() : 'N/A';

                            const listItem = document.createElement('li');
                            listItem.classList.add('transaction-item', entry.transactionType);
                            listItem.dataset.id = entryId;

                            // Use encodeURIComponent for notes and personName when passing to onclick
                            const encodedPersonName = encodeURIComponent(entry.personName);
                            const encodedNotes = encodeURIComponent(entry.notes || ''); // Handle empty notes

                            listItem.innerHTML = `
                                <div class="transaction-details">
                                    <strong>Amount</strong>: <span class="entry-amount">₹${entry.amount.toFixed(2)}</span>
                                    <span class="type-badge ${entry.transactionType}">${entry.transactionType === 'lent' ? 'You Lent' : 'You Borrowed'}</span>
                                    <br>
                                    <small>${entry.notes ? `Notes: ${entry.notes}` : 'No notes'} | ${timestampDate}</small>
                                </div>
                                <div class="transaction-actions">
                                    <button class="btn btn-warning" onclick="openEditModal('${entryId}', '${encodedPersonName}', ${entry.amount}, '${entry.transactionType}', '${encodedNotes}')">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteEntry('${entryId}')">Delete</button>
                                </div>
                            `;
                            ul.appendChild(listItem);
                        });
                        personTransactionsListDiv.appendChild(ul);
                    }, error => {
                        console.error('Error loading person transactions in real-time:', error.message);
                        showMessage('entryForPersonMessage', `Failed to load transactions: ${error.message}`, 'error');
                    });
            }
        }

        if (closePersonDetailsModalButton) {
            closePersonDetailsModalButton.onclick = function() {
                personDetailsModal.classList.remove('active');
                if (unsubscribeFromPersonTransactions) {
                    unsubscribeFromPersonTransactions(); // Unsubscribe when modal closes
                    unsubscribeFromPersonTransactions = null;
                }
            }
        }

        // Close person details modal if clicked outside content
        window.addEventListener('click', function(event) {
            if (event.target == personDetailsModal) {
                personDetailsModal.classList.remove('active');
                if (unsubscribeFromPersonTransactions) {
                    unsubscribeFromPersonTransactions(); // Unsubscribe when modal closes
                    unsubscribeFromPersonTransactions = null;
                }
            }
        });

        // Handle Add Entry form submission within Person Details Modal
        if (addEntryForPersonForm) {
            addEntryForPersonForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const personName = personDetailsModalPersonNameInput.value; // Get name from hidden input
                const amount = parseFloat(amountForPersonInput.value);
                const transactionType = transactionTypeForPersonSelect.value;
                const notes = notesForPersonTextarea.value.trim();
                hideMessage('entryForPersonMessage');

                if (isNaN(amount) || amount <= 0) {
                    showMessage('entryForPersonMessage', 'Please enter a valid positive amount.', 'error');
                    return;
                }

                const user = auth.currentUser;
                if (user) {
                    try {
                        await db.collection('users').doc(user.uid).collection('khatabook').add({
                            personName: personName,
                            amount: amount,
                            transactionType: transactionType,
                            notes: notes,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showMessage('entryForPersonMessage', 'Entry added successfully!', 'success');
                        addEntryForPersonForm.reset();
refreshPersonTransactions(); // 👈 refresh after adding entry
                        // Real-time listener for person's transactions will update
                    } catch (error) {
                        console.error('Error adding entry for person:', error.message);
                        showMessage('entryForPersonMessage', `Failed to add entry: ${error.message}`, 'error');
                    }
                } else {
                    showMessage('entryForPersonMessage', 'You must be logged in to add entries.', 'error');
                }
            });
        }


function refreshPersonTransactions() {
    const currentPersonName = personDetailsModalPersonNameInput.value;
    if (currentPersonName && typeof openPersonDetailsModal === "function") {
        openPersonDetailsModal(currentPersonName);
    }
}


    </script>
</body>
</html>
